<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>DISC Analyse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f8f8f8;
      --card: #ffffff;
      --text: #333;
      --muted: #777;
      --border: #c7c7c7;
      --primary: #007BFF;
      --primary-dark: #0056b3;
      --pill-bg: #f6f8fb;
      --pill-border: #cfd8e3;
      --pill-hover: #eef3f9;
      --pill-active: #e6eef8;
      --pill-selected-bg: #e7f1ff;
      --pill-selected-text: #0b3d91;
      --shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: var(--bg);
      color: var(--text);
    }

    #introForm {
      max-width: 500px;
      margin: 40px auto;
      background-color: var(--card);
      padding: 30px;
      border-radius: 10px;
      box-shadow: var(--shadow);
    }

    #introForm h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    .required {
      color: red;
      font-weight: bold;
      margin-left: 4px;
    }

    .prep-box {
      max-width: 600px;
      margin: 40px auto;
      background-color: var(--card);
      padding: 30px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      line-height: 1.6;
    }

    .prep-box h2,
    .prep-box h3 {
      text-align: center;
      margin-top: 20px;
    }

    .prep-box ul {
      padding-left: 20px;
    }

    .prep-box p { margin: 10px 0; }

    .intro-field {
      display: grid;
      grid-template-columns: 130px 1fr;
      gap: 12px;
      align-items: start;
      margin-bottom: 16px;
    }

    .intro-field label { font-weight: bold; }

    .intro-field input,
    .intro-field select {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .intro-field p { margin: 0; font-size: 12px; font-weight: 100; }

    select:invalid { border-color: red; }

    .question {
      background: var(--card);
      padding: 30px;
      margin: 20px auto;
      max-width: 1200px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    table { width: 100%; border-collapse: collapse; table-layout: auto; }
    td, th { padding: 10px; text-align: left; vertical-align: middle; }

    td:first-child { width: 50%; }
    td:nth-child(2), td:nth-child(3), th:nth-child(2), th:nth-child(3) { width: 25%; text-align: left; }

    td:nth-child(2), th:nth-child(2) { border-left: 1px solid var(--border); }
    td:nth-child(3), th:nth-child(3) { border-left: 1px solid var(--border); }

    th { background-color: #efefef; }

    /* 6 klikbare Likert "pills" */
    .likert-labels {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .likert-labels span {
      padding: 8px 10px;
      border-radius: 9999px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      background: var(--pill-bg);
      border: 1px solid var(--pill-border);
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
      color: var(--text);
      transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .likert-labels span:hover { background: var(--pill-hover); border-color: #b8c6d8; }
    .likert-labels span:active { background: var(--pill-active); border-color: #a7b9d1; box-shadow: inset 0 1px 2px rgba(0,0,0,0.06); }
    .likert-labels span:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(0,123,255,0.2); }
    .likert-labels span.selected {
      background: var(--pill-selected-bg);
      border: 1px solid var(--primary);
      color: var(--pill-selected-text);
      font-weight: 600;
    }

    .submit-button {
      display: block;
      margin: 40px auto 0;
      padding: 16px 32px;
      font-size: 18px;
      background-color: var(--primary);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .submit-button:hover { background-color: var(--primary-dark); }

    @media (max-width: 768px) {
      td:first-child { width: auto; }
      .question { padding: 20px; }
    }
  </style>
</head>
<body>
  <div id="introForm">
    <h2>Velkommen til DISC-analysen</h2>

    <div class="intro-field">
      <label for="inputDato">Dato:<span class="required">*</span></label>
      <input type="date" id="inputDato" required />
    </div>

    <div class="intro-field">
      <label for="inputFornavn">Fornavn:<span class="required">*</span></label>
      <input type="text" id="inputFornavn" required />
    </div>

    <div class="intro-field">
      <label for="inputEfternavn">Efternavn:<span class="required">*</span></label>
      <input type="text" id="inputEfternavn" required />
    </div>

    <div class="intro-field">
      <label for="inputKoen">Køn:<span class="required">*</span></label>
      <select id="inputKoen" required>
        <option value="">__</option>
        <option value="Mand">Mand</option>
        <option value="Kvinde">Kvinde</option>
        <option value="Andet">Andet</option>
      </select>
    </div>

    <div class="intro-field">
      <label for="inputFirma">Firma:</label>
      <input type="text" id="inputFirma" />
    </div>

    <div class="intro-field">
      <label for="inputEmail">E-mail:<span class="required">*</span></label>
      <input type="email" id="inputEmail" required />
    </div>

    <!-- Samtykke -->
    <div class="intro-field">
      <label>Samtykke:<span class="required">*</span>
        <input type="checkbox" id="inputSamtykke" required>
      </label>
      <p>
        Jeg giver hermed samtykke til, at den information jeg afgiver til udfyldelse af min DISCline profil,
        kan anvendes til rekruttering og udviklingsaktiviteter relateret til mig.
        Jeg giver tilsagn om, at jeg er over 16 år gammel. Mine data bliver bevaret og slettet jævnfør EU-lov om opbevaring og sletning af persondata.
        <br><br>Har du spørgsmål til denne, kontakt venligst Coachers på: <br>tlf: <a href="tel:+4520845503">+45 20 84 55 03</a><br>mail: <a href="mailto:pb@coachers.dk">pb@coachers.dk</a>
      </p>
    </div>

    <button type="button" onclick="startSurvey()" class="submit-button" style="margin-top: 20px;">Start analysen</button>
    <p style="text-align: center; font-size: 12px; color: var(--muted); margin-top: 20px;">
      Denne side er senest ændret d. 4. september 2025 (21:47)
    </p>
  </div>

  <div id="prepScreen" class="prep-box" style="display: none;">
    <h2>Vigtige forberedelser</h2>
    <p>For at sikre det bedste resultat af analysen, anbefaler vi følgende:</p>
    <ul>
      <li>Sørg for, at du kan koncentrere dig uden forstyrrelser. Slå din telefon på lydløs, og find et stille sted.</li>
      <li>Besvar alle udsagn med udgangspunkt i den samme arbejdssituation. Dette er vigtigt for at skabe et klart og sammenhængende billede.</li>
    </ul>

    <h3>Tidsramme og besvarelse</h3>
    <ul>
      <li>Brug maks. 10-12 minutter på at udfylde analysen.</li>
      <li>Vælg det svar, der naturligt falder dig ind som det første. Det giver det mest præcise resultat.</li>
    </ul>

    <h3>Enhed og udstyr</h3>
    <ul>
      <li>Vi anbefaler, at du bruger en PC eller en tablet med en tilpas stor skærm.</li>
      <li>Undgå at bruge en mobiltelefon, da det kan forringe resultatet.</li>
    </ul>

    <p>God fornøjelse!</p>
    <p>Hvis du har spørgsmål eller oplever tekniske problemer, er du altid velkommen til at kontakte os.</p>

    <p>
      <strong>Preben Braagaard</strong><br />
      Coachers<br />
      Telefon: <a href="tel:+4520845503">+45 20 84 55 03</a><br />
      E-mail: <a href="mailto:pb@coachers.dk">pb@coachers.dk</a>
    </p>

    <button type="button" onclick="showSurvey()" class="submit-button">Fortsæt</button>
  </div>

  <div id="questions" style="display:none;" aria-live="polite"></div>

  <!-- NY DOWNLOAD-SIDE -->
  <div id="downloadScreen" class="prep-box" style="display:none;" aria-live="polite">
    <h2>Næsten færdig – download din besvarelse</h2>
    <p>
      Tak for din besvarelse. Klik på <strong>Download</strong> herunder for at hente din JSON-fil.
      Send den derefter straks til <a href="mailto:pb@coachers.dk">pb@coachers.dk</a>.
    </p>
    <button type="button" onclick="handleDownloadClick()" class="submit-button">Download</button>
    <p style="font-size:12px;color:var(--muted);margin-top:12px;">
      Hvis "Download" ikke virker, prøv i en anden browser (Chrome/Edge) eller tillad pop-ups.
    </p>
  </div>

  <div id="thankYouScreen" class="prep-box" style="display: none;" aria-live="polite">
    <h2>Tak!</h2>
    <p>Din fil burde nu være downloadet. Husk at sende den til <a href="mailto:pb@coachers.dk">pb@coachers.dk</a>.</p>
    <p>Du kan nu lukke denne side.</p>
  </div>

  <script>
    // ---------- State ----------
    let respondentInfo = {};
    let likertItems = [];
    let likertQuestions = [];
    let likertAnswers = [];
    let likertCurrent = 0;
    let surveyStartTs = null;

    // ---------- Helpers ----------
    // 6-punkt skala: 1..6 -> [-5, -3, -1, 1, 3, 5]
    const getPoints = (val) => ({ 1:-5, 2:-3, 3:-1, 4:1, 5:3, 6:5 }[val] ?? 0);

    // Skalerer sum i intervallet [-5*count, +5*count] til [0,100]
    const calculateRawValue = (sum, count) => {
      if (!count || count <= 0) return 0;
      const maxPositive = count * 5; // pr. item +5 max
      return Math.round(((sum + maxPositive) / (2 * maxPositive)) * 100);
    };

    // For hver kategori (Arbejde/Naturlig), skaler 4 dimensioner til sum ~200 (maks 100 pr. dim)
    const normalizeToSum200 = (value, sum) => {
      if (sum === 0) return 0;
      return Math.min(100, Math.round((value / sum) * 200));
    };

    const mean = (a, b) => (Number(a || 0) + Number(b || 0)) / 2;

    const pairPenalty = (a, b, hi = 65, lo = 35) => {
      let p = 0;
      if (a >= hi && b >= hi) {
        p = ((Math.min(a, b) - hi) / (100 - hi)) * 10;
      } else if (a <= lo && b <= lo) {
        p = ((lo - Math.max(a, b)) / lo) * 10;
      }
      return Math.max(0, Math.min(10, p));
    };

    const toBool = (val) => {
      if (val == null) return false;
      const v = String(val).trim().toLowerCase();
      return v === "true" || v === "1" || v === "ja" || v === "yes" || v === "y" || v === "x";
    };

    // ---------- Data loading ----------
    function fetchLikertItems() {
      const path = "disc_udsagn_2.5.csv";

      function splitCSVLine(line) {
        const cols = [];
        let cur = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; }
            else { inQuotes = !inQuotes; }
          } else if (ch === ',' && !inQuotes) {
            cols.push(cur);
            cur = "";
          } else {
            cur += ch;
          }
        }
        cols.push(cur);
        return cols;
      }

      return fetch(path)
        .then((response) => response.text())
        .then((data) => {
          const rawLines = data.trim().split(/\r?\n/);
          const lines = rawLines.slice(1); // skip header
          likertItems = [];
          lines.forEach((line) => {
            if (!line.trim()) return;
            const cols = splitCSVLine(line.replace(/\r$/, ''));
            if (cols.length < 4) return;
            const udsagn = String(cols[0] || "").trim().replace(/^"|"$/g, "");
            const disc = String(cols[1] || "").trim().toUpperCase();
            const reverse = toBool(cols[2]);
            const test = toBool(cols[3]);
            if (!udsagn) return;
            likertItems.push({ text: udsagn, disc, reverse, test });
          });

          // Shuffle for at undgå rækkefølge-bias
          for (let i = likertItems.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [likertItems[i], likertItems[j]] = [likertItems[j], likertItems[i]];
          }

          // Grupper i 4 udsagn
          likertQuestions = [];
          for (let i = 0; i < likertItems.length; i += 4) {
            const group = likertItems.slice(i, i + 4);
            if (group.length === 4) likertQuestions.push({ items: group });
          }

          // Init svar-grid
          likertAnswers = likertQuestions.map((q) =>
            q.items.map((item) => ({
              text: item.text,
              disc: item.disc || "",
              reverse: !!item.reverse,
              test: !!item.test,
              naturlig: null,
              arbejde: null,
            }))
          );
          likertCurrent = 0;
        })
        .catch((err) => {
          console.error("Kunne ikke hente Likert-CSV:", err);
          alert("Der opstod en fejl ved indlæsning af Likert-spørgerammen.");
        });
    }

    // ---------- Rendering ----------
    function renderLikertSurvey() {
      const container = document.getElementById("questions");
      container.innerHTML = "";

      const q = likertQuestions[likertCurrent];
      const wrapper = document.createElement("div");
      wrapper.classList.add("question");

      const header = document.createElement("h2");
      header.style.marginTop = "0";
      header.textContent = `Spørgsmål ${likertCurrent + 1}: I hvilken grad passer nedenstående udsagn på dig?`;
      wrapper.appendChild(header);

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Udsagn</th>
            <th>Min naturlige adfærd</th>
            <th>Adfærd på mit arbejde</th>
          </tr>
        </thead>
        <tbody id="likert-body"></tbody>
      `;
      wrapper.appendChild(table);

      const tbody = table.querySelector("#likert-body");
      const labels = ["Meget uenig", "Uenig", "Lidt uenig", "Lidt enig", "Enig", "Meget enig"];

      q.items.forEach((item, row) => {
        const answer = likertAnswers[likertCurrent][row];
        const tr = document.createElement("tr");

        const tdText = document.createElement("td");
        tdText.textContent = item.text;
        tdText.style.fontSize = "18px";
        tdText.style.fontWeight = "600";
        tr.appendChild(tdText);

        const makeCell = (type) => {
          const td = document.createElement("td");
          td.style.textAlign = "left";
          td.style.verticalAlign = "middle";

          const labelBar = document.createElement("div");
          labelBar.className = "likert-labels";

          const labelSpans = [];
          for (let v = 1; v <= 6; v++) {
            const sp = document.createElement("span");
            sp.textContent = labels[v - 1];
            sp.dataset.val = String(v);
            labelBar.appendChild(sp);
            labelSpans.push(sp);
          }
          td.appendChild(labelBar);

          const currentVal = type === "naturlig" ? answer.naturlig : answer.arbejde;

          const updateLabels = (val) => {
            labelSpans.forEach((sp) => {
              if (parseInt(sp.dataset.val, 10) === val) sp.classList.add("selected");
              else sp.classList.remove("selected");
            });
          };
          if (currentVal != null) updateLabels(currentVal);

          labelSpans.forEach((sp) => {
            sp.addEventListener("click", () => {
              const v = parseInt(sp.dataset.val, 10);
              updateLabels(v);
              likertAnswers[likertCurrent][row][type] = v;
            });
          });

          return td;
        };

        tr.appendChild(makeCell("naturlig"));
        tr.appendChild(makeCell("arbejde"));
        tbody.appendChild(tr);
      });

      const nextBtn = document.createElement("button");
      nextBtn.className = "submit-button";
      nextBtn.type = "button";

      // Hvis dette er sidste spørgsmål, vis "Fortsæt" og gå til download-siden i stedet for prompt
      const isLastQuestion = (likertCurrent === likertQuestions.length - 1);
      nextBtn.textContent = isLastQuestion ? "Fortsæt" : "Næste";

      nextBtn.onclick = () => {
        const rows = likertAnswers[likertCurrent];
        const incomplete = rows.findIndex((r) => r.naturlig == null || r.arbejde == null);
        if (incomplete !== -1) {
          alert("Udfyld venligst alle vurderinger (begge kolonner) før du fortsætter.");
          return;
        }

        // Specifikt krav: efter spørgsmål nr. 12 -> downloadside
        // (virker også hvis 12 er det sidste; ellers går vi videre normalt)
        const isQ12 = (likertCurrent === 11); // 0-indekseret => 12. spørgsmål
        if (isQ12 || isLastQuestion) {
          document.getElementById("questions").style.display = "none";
          document.getElementById("downloadScreen").style.display = "block";
          return;
        }

        // Næste spørgsmål
        likertCurrent += 1;
        renderLikertSurvey();
      };

      wrapper.appendChild(nextBtn);
      container.appendChild(wrapper);
    }

    // ---------- Scoring ----------
    function scoreFromAnswers(detailedAnswers, useDurationSeconds = null) {
      const sumArbejde = { D: 0, I: 0, S: 0, C: 0 };
      const sumNaturlig = { D: 0, I: 0, S: 0, C: 0 };
      const countPerDim = { D: 0, I: 0, S: 0, C: 0 };

      let testPenalty = 0;
      let contradictionPenalty = 0;

      const contradict = {
        arbejde: { D: { normMax: false, revMax: false }, I: { normMax: false, revMax: false }, S: { normMax: false, revMax: false }, C: { normMax: false, revMax: false } },
        naturlig: { D: { normMax: false, revMax: false }, I: { normMax: false, revMax: false }, S: { normMax: false, revMax: false }, C: { normMax: false, revMax: false } },
      };

      for (const ans of detailedAnswers) {
        const dim = (ans.disc || "").toUpperCase();
        if (!["D", "I", "S", "C"].includes(dim)) continue;

        const isRev = !!ans.isReverse;
        const isTest = !!ans.isTest;

        const vArbejde = Number(ans.arbejde?.value);
        const vNaturlig = Number(ans.naturlig?.value);

        // Test-penalty: høj enighed (≥5) på ja-items / lav (≤2) på reverse
        if (isTest) {
          if (!isRev) {
            if (vArbejde >= 5) testPenalty += 7;
            if (vNaturlig >= 5) testPenalty += 7;
          } else {
            if (vArbejde <= 2) testPenalty += 7;
            if (vNaturlig <= 2) testPenalty += 7;
          }
        } else {
          const sArbejde = isRev ? -getPoints(vArbejde) : getPoints(vArbejde);
          const sNaturlig = isRev ? -getPoints(vNaturlig) : getPoints(vNaturlig);
          sumArbejde[dim] += sArbejde;
          sumNaturlig[dim] += sNaturlig;
          countPerDim[dim] += 1;
        }

        // Modstrid: max (6) på både normal og reverse
        if (vArbejde === 6) { if (isRev) contradict.arbejde[dim].revMax = true; else contradict.arbejde[dim].normMax = true; }
        if (vNaturlig === 6) { if (isRev) contradict.naturlig[dim].revMax = true; else contradict.naturlig[dim].normMax = true; }
      }

      const raw = {
        D1: calculateRawValue(sumArbejde.D, countPerDim.D),
        I1: calculateRawValue(sumArbejde.I, countPerDim.I),
        S1: calculateRawValue(sumArbejde.S, countPerDim.S),
        C1: calculateRawValue(sumArbejde.C, countPerDim.C),
        D2: calculateRawValue(sumNaturlig.D, countPerDim.D),
        I2: calculateRawValue(sumNaturlig.I, countPerDim.I),
        S2: calculateRawValue(sumNaturlig.S, countPerDim.S),
        C2: calculateRawValue(sumNaturlig.C, countPerDim.C),
      };

      const sumA = raw.D1 + raw.I1 + raw.S1 + raw.C1;
      const sumN = raw.D2 + raw.I2 + raw.S2 + raw.C2;

      const score = {
        D1: normalizeToSum200(raw.D1, sumA),
        I1: normalizeToSum200(raw.I1, sumA),
        S1: normalizeToSum200(raw.S1, sumA),
        C1: normalizeToSum200(raw.C1, sumA),
        D2: normalizeToSum200(raw.D2, sumN),
        I2: normalizeToSum200(raw.I2, sumN),
        S2: normalizeToSum200(raw.S2, sumN),
        C2: normalizeToSum200(raw.C2, sumN),
      };

      const Dm = mean(score.D1, score.D2);
      const Im = mean(score.I1, score.I2);
      const Sm = mean(score.S1, score.S2);
      const Cm = mean(score.C1, score.C2);

      const hasDS = countPerDim.D > 0 && countPerDim.S > 0;
      const hasIC = countPerDim.I > 0 && countPerDim.C > 0;

      const penaltyDS = hasDS ? pairPenalty(Dm, Sm) : 0;
      const penaltyIC = hasIC ? pairPenalty(Im, Cm) : 0;
      const axisPenalty = Math.min(20, Math.round(penaltyDS + penaltyIC));

      ["arbejde", "naturlig"].forEach((ctx) => {
        ["D", "I", "S", "C"].forEach((dim) => {
          const f = contradict[ctx][dim];
          if (f.normMax && f.revMax) contradictionPenalty += 7;
        });
      });

      // Tids-penalty
      let durationSec;
      if (useDurationSeconds != null) durationSec = Math.max(0, Math.round(useDurationSeconds));
      else {
        const finishedAt = Date.now();
        durationSec = Math.max(0, Math.round((finishedAt - (surveyStartTs || finishedAt)) / 1000));
      }

      let timePenalty = 0;
      const minSec = 75, maxSec = 150;
      if (durationSec <= minSec) timePenalty = 50;
      else if (durationSec < maxSec) timePenalty = 50 * (maxSec - durationSec) / (maxSec - minSec);

      const totalPenalty = Math.round(timePenalty) + axisPenalty + testPenalty + contradictionPenalty;
      const validitet = Math.max(0, Math.round(100 - totalPenalty));

      return {
        score,
        validitet,
        penaltyBreakdown: {
          timePenalty: Math.round(timePenalty),
          axisPenalty,
          testPenalty,
          contradictionPenalty,
          totalPenalty,
        },
        durationSec,
      };
    }

    // ---------- Download / finalize ----------
    function handleDownloadClick() {
      downloadLikertJSON(); // ingen prompt – direkte download
    }

    async function downloadLikertJSON(previousResultsText) {
      let isRecompute = false;
      let previousResults = null;

      if (previousResultsText) {
        isRecompute = true;
        try { previousResults = JSON.parse(previousResultsText); }
        catch (e) { alert("Ugyldig JSON-fil."); return; }
        if (!previousResults.detailedAnswers || !Array.isArray(previousResults.detailedAnswers)) {
          alert("Ugyldig JSON-fil: mangler 'detailedAnswers' array."); return;
        }
      } else {
        // Valider alle spørgsmål
        for (let q = 0; q < likertAnswers.length; q++) {
          const rows = likertAnswers[q];
          const incomplete = rows.findIndex((r) => r.naturlig == null || r.arbejde == null);
          if (incomplete !== -1) {
            alert(`Spørgsmål ${q + 1} mangler besvarelser. Udfyld venligst alle vurderinger.`);
            likertCurrent = q;
            document.getElementById("downloadScreen").style.display = "none";
            document.getElementById("questions").style.display = "block";
            renderLikertSurvey();
            return;
          }
        }
      }

      let detailedAnswers, startTidStr, slutTidStr;
      if (isRecompute) {
        detailedAnswers = previousResults.detailedAnswers;
        startTidStr = previousResults.startTid || null;
        slutTidStr = previousResults.slutTid || null;

        // Kun felter vi stadig bruger
        const { dato, fornavn, efternavn, koen, firma, email } = previousResults;
        respondentInfo = {
          ...(respondentInfo || {}),
          ...(dato ? { dato } : {}),
          ...(fornavn ? { fornavn } : {}),
          ...(efternavn ? { efternavn } : {}),
          ...(koen ? { koen } : {}),
          ...(firma ? { firma } : {}),
          ...(email ? { email } : {}),
        };
      } else {
        detailedAnswers = [];
        const labels = ["Meget uenig", "Uenig", "Lidt uenig", "Lidt enig", "Enig", "Meget enig"];

        for (let q = 0; q < likertQuestions.length; q++) {
          const items = likertQuestions[q].items;
          const rows = likertAnswers[q];
          for (let r = 0; r < rows.length; r++) {
            const row = rows[r];
            const dim = (row.disc || "").toUpperCase();
            const isRev = !!row.reverse;
            const isTest = !!row.test;
            const vArbejde = Number(row.arbejde);
            const vNaturlig = Number(row.naturlig);

            detailedAnswers.push({
              question: row.text,
              disc: dim,
              naturlig: {
                value: vNaturlig,
                label: labels[vNaturlig - 1],
                points: isRev ? -getPoints(vNaturlig) : getPoints(vNaturlig),
              },
              arbejde: {
                value: vArbejde,
                label: labels[vArbejde - 1],
                points: isRev ? -getPoints(vArbejde) : getPoints(vArbejde),
              },
              isReverse: isRev,
              isTest: isTest,
            });
          }
        }
      }

      // Varighed fra fil ved genberegning
      let durationOverride = null;
      if (isRecompute && startTidStr && slutTidStr) {
        const start = Date.parse(startTidStr);
        const end = Date.parse(slutTidStr);
        if (!Number.isNaN(start) && !Number.isNaN(end) && end > start) {
          durationOverride = Math.round((end - start) / 1000);
        }
      }

      const { score, validitet, penaltyBreakdown, durationSec } =
        scoreFromAnswers(detailedAnswers, durationOverride);

      const finishedAt = isRecompute
        ? (slutTidStr ? Date.parse(slutTidStr) : Date.now())
        : Date.now();

      const result = {
        ...respondentInfo,
        startTid: isRecompute
          ? (startTidStr || null)
          : (surveyStartTs ? new Date(surveyStartTs).toISOString() : null),
        slutTid: new Date(finishedAt).toISOString(),
        besvarelsestidSek: durationOverride != null ? durationOverride : durationSec,
        validitet,
        score,
        detailedAnswers,
        penaltyBreakdown,
      };

      const jsonBlob = new Blob([JSON.stringify(result, null, 2)], { type: "application/json" });

      try {
        if (window.showSaveFilePicker) {
          const handle = await window.showSaveFilePicker({
            suggestedName: "disc-resultat.json",
            types: [{ description: "JSON-fil", accept: { "application/json": [".json"] } }],
          });
          const writable = await handle.createWritable();
          await writable.write(jsonBlob);
          await writable.close();
        } else {
          const url = URL.createObjectURL(jsonBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "disc-resultat.json";
          link.click();
          URL.revokeObjectURL(url);
        }
      } catch (e) {
        alert("Kunne ikke gemme filen.");
      }

      document.getElementById("downloadScreen").style.display = "none";
      document.getElementById("thankYouScreen").style.display = "block";
    }

    // ---------- Flow ----------
    function startSurvey() {
      const rawDate = document.getElementById("inputDato").value;
      const parts = rawDate.split("-");
      const dato = parts.length === 3 ? `${parts[2]}${parts[1]}${parts[0]}` : "";

      const fornavn = document.getElementById("inputFornavn").value;
      const efternavn = document.getElementById("inputEfternavn").value;
      const koen = document.getElementById("inputKoen").value;
      const firma = document.getElementById("inputFirma").value;
      const email = document.getElementById("inputEmail").value;
      const samtykke = document.getElementById("inputSamtykke").checked;

      if (!dato || !fornavn || !efternavn || !email || !koen || !samtykke) {
        alert("Du skal udfylde alle felter og give samtykke for at fortsætte.");
        return;
      }

      respondentInfo = { dato, fornavn, efternavn, koen, firma, email };

      document.getElementById("introForm").style.display = "none";
      document.getElementById("prepScreen").style.display = "block";
    }

    function showSurvey() {
      surveyStartTs = Date.now();
      document.getElementById("prepScreen").style.display = "none";
      document.getElementById("questions").style.display = "block";

      fetchLikertItems().then(() => {
        renderLikertSurvey();
      });
    }

    // ---------- Dev Shortcut (Ctrl+Alt+D) ----------
    window.addEventListener("keydown", function (e) {
      if (e.ctrlKey && e.altKey && e.key.toLowerCase() === "d") {
        e.preventDefault();
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = ".json";
        fileInput.style.display = "none";
        document.body.appendChild(fileInput);

        fileInput.addEventListener("change", function () {
          const files = fileInput.files;
          if (files && files.length > 0) {
            const reader = new FileReader();
            reader.onload = function (evt) {
              try {
                document.getElementById("introForm").style.display = "none";
                // Gå direkte til download med genberegning
                downloadLikertJSON(evt.target.result);
              } catch (error) {
                alert(`Der opstod en fejl ved behandling af JSON-filen: ${error.message}`);
              }
            };
            reader.onerror = function () { alert("Der opstod en fejl ved læsning af filen."); };
            reader.readAsText(files[0]);
          }
          document.body.removeChild(fileInput);
        }, { once: true });

        fileInput.click();
      }
    });

    // ---------- Startup ----------
    window.addEventListener("DOMContentLoaded", () => {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      const todayString = `${yyyy}-${mm}-${dd}`;
      document.getElementById("inputDato").value = todayString;

      if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" || window.location.hostname.includes("test")) {
        const devIndicator = document.createElement("div");
        devIndicator.style.position = "fixed";
        devIndicator.style.bottom = "2px";
        devIndicator.style.right = "2px";
        devIndicator.style.fontSize = "8px";
        devIndicator.style.color = "#ddd";
        devIndicator.style.opacity = "0.3";
        devIndicator.style.padding = "1px";
        devIndicator.style.fontFamily = "monospace";
        devIndicator.title = "Tryk Ctrl+Alt+D for udviklerværktøjer";
        devIndicator.textContent = "·";
        document.body.appendChild(devIndicator);
      }
    });
  </script>
</body>
</html>
