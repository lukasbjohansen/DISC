<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>DISC Analyse</title>
  <style>
  #introForm {
  max-width: 500px;
  margin: 40px auto;
  background-color: #ffffff;
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

#introForm h2 {
  text-align: center;
  margin-bottom: 20px;
}

.required {
  color: red;
  font-weight: bold;
  margin-left: 4px;
}
.prep-box {
  max-width: 600px;
  margin: 40px auto;
  background-color: #ffffff;
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  line-height: 1.6;
}

.prep-box h2,
.prep-box h3 {
  text-align: center;
  margin-top: 20px;
}

.prep-box ul {
  padding-left: 20px;
}

.prep-box p {
  margin: 10px 0;
}


.intro-field {
  display: grid;
  grid-template-columns: 130px 1fr;
  gap: 12px;
  align-items: start;
  margin-bottom: 16px;
}
select:invalid {
  border-color: red;
}


.intro-field label {
  flex: 0 0 120px;
  font-weight: bold;
}

.intro-field input {
  flex: 1;
  padding: 8px;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
.intro-field p {
	margin: 0;
	font-size: 12px;
	font-weight: 100;
}

  body {
    font-family: Arial, sans-serif;
    margin: 40px;
    background-color: #f8f8f8;
  }

  h1 {
    text-align: center;
    color: #333;
  }

  .question {
    background: #fff;
    padding: 30px;
    margin: 20px auto;
    max-width: 1200px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .intro-field select {
  padding: 8px;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 4px;
  }


  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto;
  }

  td, th {
    padding: 10px;
    text-align: left;
    vertical-align: middle;
  }

  td:first-child {
    width: 50%;
  }

  td:nth-child(2), td:nth-child(3), th:nth-child(2), th:nth-child(3) {
    width: 25%;
    text-align: left;
  }

  /* Dobbelte vertikale streger mellem de tre kolonner */
  td:nth-child(2), th:nth-child(2) {
    border-left: 1px solid #c7c7c7;
  }
  td:nth-child(3), th:nth-child(3) {
    border-left: 1px solid #c7c7c7;
  }

  th {
    background-color: #efefef;
  }

  input[type="radio"] {
    width: 24px;
    height: 24px;
    cursor: pointer;
    accent-color: #007BFF;
    transform: translateY(2px);
  }

  /* Sliders (Likert) */
  input[type="range"] {
    width: calc(100% - 24px); /* s√• track slutter under knappen ved min/max */
    height: 26px; /* plads til thumb */
    margin: 0 12px; /* ~¬Ω thumb i begge sider */
    background: transparent;
    display: block;
  }
  /* WebKit (Chrome/Edge/Safari) */
  input[type="range"]::-webkit-slider-runnable-track {
    height: 6px; /* smallere baggrund */
    background: #e6e6e6;
    border: 1px solid #ccc;
    border-radius: 6px;
    position: relative;
    /* 5 lodrette tick-linjer oven p√• tracket ved 0%, 25%, 50%, 75%, 100% */
    background-image:
      linear-gradient(#999, #999),
      linear-gradient(#999, #999),
      linear-gradient(#999, #999),
      linear-gradient(#999, #999),
      linear-gradient(#999, #999);
    background-size: 1px 100%, 1px 100%, 1px 100%, 1px 100%, 1px 100%;
    background-position: 0% 50%, 25% 50%, 50% 50%, 75% 50%, 100% 50%;
    background-repeat: no-repeat;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #007BFF;
    border: 2px solid #0056b3;
    margin-top: -7px; /* finjusteret centrering p√• 6px track */
    cursor: pointer;
  }
  /* Firefox */
  input[type="range"]::-moz-range-track {
    height: 6px; /* smallere baggrund */
    background: #e6e6e6;
    border: 1px solid #ccc;
    border-radius: 6px;
    /* 5 lodrette tick-linjer oven p√• tracket ved 0%, 25%, 50%, 75%, 100% */
    background-image:
      linear-gradient(#999, #999),
      linear-gradient(#999, #999),
      linear-gradient(#999, #999),
      linear-gradient(#999, #999),
      linear-gradient(#999, #999);
    background-size: 1px 100%, 1px 100%, 1px 100%, 1px 100%, 1px 100%;
    background-position: 0% 50%, 25% 50%, 50% 50%, 75% 50%, 100% 50%;
    background-repeat: no-repeat;
  }
  input[type="range"]::-moz-range-thumb {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #007BFF;
    border: 2px solid #0056b3;
    cursor: pointer;
  }

  /* Slider container (beholder) */
  .slider-wrap {
    position: relative;
    width: 100%;
    max-width: 700px;
    margin: 0; /* venstrestillet */
  }

  /* Unanswered state: skjul thumb og skjul track indtil valg */
  .slider-wrap.unanswered input[type="range"]::-webkit-slider-thumb { opacity: 0; }
  .slider-wrap.unanswered input[type="range"]::-moz-range-thumb { opacity: 0; }
  .slider-wrap.unanswered input[type="range"]::-webkit-slider-runnable-track { opacity: 0; }
  .slider-wrap.unanswered input[type="range"]::-moz-range-track { opacity: 0; }

  /* Klikbare Likert-labels */
  .likert-labels {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
    font-size: 12px;
    margin-bottom: 8px;
  }
  .likert-labels span {
    padding: 8px 10px;
    border-radius: 9999px; /* pill */
    text-align: center;
    cursor: pointer;
    user-select: none;
    white-space: nowrap; /* undg√• linjeskift i fx 'Meget uenig' */
    background: #f6f8fb;
    border: 1px solid #cfd8e3;
    box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    color: #333;
    transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
  }
  .likert-labels span:hover {
    background: #eef3f9;
    border-color: #b8c6d8;
  }
  .likert-labels span:active {
    background: #e6eef8;
    border-color: #a7b9d1;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.06);
  }
  .likert-labels span:focus-visible {
    outline: none;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.2);
  }
  .likert-labels span.selected {
    background: #e7f1ff;
    border: 1px solid #007BFF;
    color: #0b3d91;
    font-weight: 600;
  }
  .ticks-overlay {
    pointer-events: none;
    position: absolute;
    left: 0;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    height: 6px; /* matcher track-h√∏jde */
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    align-items: stretch; /* fyld hele track-h√∏jden */
  }
  .ticks-overlay span {
    justify-self: center;
    width: 1px;
    height: 100%; /* pr√¶cis samme h√∏jde som track */
    background: #999;
    border-radius: 1px;
  }

  td label {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }

  hr {
    border: none;
    border-top: 1px solid #ddd;
  }

  .submit-button {
    display: block;
    margin: 40px auto;
    padding: 16px 32px;
    font-size: 18px;
    background-color: #007BFF;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  .submit-button:hover {
    background-color: #0056b3;
  }
</style>

</head>
<body>
  <div id="introForm">
  <h2>Velkommen til DISC-analysen</h2>

  <div class="intro-field">
    <label for="inputDato">Dato:<span class="required">*</span></label>
    <input type="date" id="inputDato" required>
  </div>

  <div class="intro-field">
    <label for="inputFornavn">Fornavn:<span class="required">*</span></label>
    <input type="text" id="inputFornavn" required>
  </div>

  <div class="intro-field">
    <label for="inputEfternavn">Efternavn:<span class="required">*</span></label>
    <input type="text" id="inputEfternavn" required>
  </div>

  <div class="intro-field">
  <label for="inputProfiltype">Profiltype: <span class="required">*</span></label>
    <select id="inputProfiltype" required>
      <option value="Basic">Basic</option>
      <option value="S√¶lger">S√¶lger</option>
      <option value="Leder">Leder</option>
    </select>
  </div>

  <div class="intro-field">
  <label for="inputSpoergeramme">Sp√∏rgeramme: <span class="required">*</span></label>
    <select id="inputSpoergeramme" required>
        <option value="Likert">Likert</option>
        <option value="Pro">Pro</option>
        <option value="Oprindelig">Oprindelig</option>
    </select>
  </div>

  <div class="intro-field">
	  <label for="inputKoen">K√∏n:<span class="required">*</span></label>
	  <select id="inputKoen" required>
	    <option value="">__</option>
	    <option value="Mand">Mand</option>
	    <option value="Kvinde">Kvinde</option>
	    <option value="Andet">Andet</option>
	  </select>
  </div>

  <div class="intro-field">
    <label for="inputFirma">Firma:</label>
    <input type="text" id="inputFirma">
  </div>

  <div class="intro-field">
    <label for="inputEmail">E-mail:<span class="required">*</span></label>
    <input type="email" id="inputEmail" required>
  </div>

  <div class="intro-field">
    <label>Samtykke:<span class="required">*</span>
    <input type="checkbox" id="inputSamtykke" required></label>
    <p>
        Jeg giver hermed samtykke til, at den information jeg afgiver til udfyldelse af min DISCline profil,
	    kan anvendes til rekruttering og udviklingsaktiviteter relateret til mig.
	    Jeg giver tilsagn om, at jeg er over 16 √•r gammel. Mine data bliver bevaret og slettet j√¶vnf√∏r EU-lov om opbevaring og sletning af persondata.
	    <br><br>Har du sp√∏rgsm√•l til denne, kontakt venligst Coachers p√•: <br>tlf: <a href="tel:+4520845503">+45 20 84 55 03</a><br>mail: <a href="mailto:pb@coachers.dk">pb@coachers.dk</a>
    </p>
  </div>

  <button onclick="startSurvey()" class="submit-button" style="margin-top: 20px;">Start analysen</button>
</div>
  <div id="prepScreen" class="prep-box" style="display: none;">
  <h2>Vigtige forberedelser</h2>
  <p>For at sikre det bedste resultat af analysen, anbefaler vi f√∏lgende:</p>
  <ul>
    <li>S√∏rg for, at du kan koncentrere dig uden forstyrrelser. Sl√• din telefon p√• lydl√∏s, og find et stille sted.</li>
    <li>Besvar alle udsagn med udgangspunkt i den samme arbejdssituation. Dette er vigtigt for at skabe et klart og sammenh√¶ngende billede.</li>
  </ul>

  <h3>Tidsramme og besvarelse</h3>
  <ul>
    <li>Brug maks. 10-12 minutter p√• at udfylde analysen.</li>
    <li>V√¶lg det svar, der naturligt falder dig ind som det f√∏rste. Det giver det mest pr√¶cise resultat.</li>
  </ul>

  <h3>Enhed og udstyr</h3>
  <ul>
    <li>Vi anbefaler, at du bruger en PC eller en tablet med en tilpas stor sk√¶rm.</li>
    <li>Undg√• at bruge en mobiltelefon, da det kan forringe resultatet.</li>
  </ul>

  <p>God forn√∏jelse!</p>
  <p>Hvis du har sp√∏rgsm√•l eller oplever tekniske problemer, er du altid velkommen til at kontakte os.</p>

  <p>
    <strong>Preben Braagaard</strong><br>
    Coachers<br>
    Telefon: <a href="tel:+4520845503">+45 20 84 55 03</a><br>
    E-mail: <a href="mailto:pb@coachers.dk">pb@coachers.dk</a>
  </p>

  <button onclick="showSurvey()" class="submit-button">Forts√¶t</button>
</div>


<div id="questions" style="display:none;"></div>
  <div id="thankYouScreen" class="prep-box" style="display: none;">
  <h2>Tak for din besvarelse!</h2>
  <p>Du f√•r besked fra <strong>Coachers</strong>, n√•r din DISCline-profil er klar.</p>
	  <p>Hvis du har nogen sp√∏rgsm√•l kan du kontakte <strong>Preben Braagaard</strong> p√• <br>Telefon: <a href="tel:+4520845503">+45 20 84 55 03</a><br>E-mail: <a href="mailto:pb@coachers.dk">pb@coachers.dk</a><br><br></p>
  <p>Du kan nu lukke denne side.</p>
</div>





  </form>

  <script>
let discMap = {};
let questions = [];
let answers = []; // Gemmer DISC-svar som f.eks. { mest: "D", mindst: "S" }
let respondentInfo = {};
let likertItems = [];
let likertQuestions = [];
let likertAnswers = [];
let likertCurrent = 0;

// Kun l√¶s og forbered sp√∏rgsm√•lene ‚Äì men vis dem f√∏rst senere
function fetchQuestions(ramme) {
  let path = ramme === "Pro" ? "disc_udsagn_pro.csv" : "disc_udsagn_oprindelig.csv";

  return fetch(path)
  .then(response => response.text())
  .then(data => {
    const lines = data.trim().split('\n').slice(1); // skip header line
    questions = [];

    lines.forEach((line, idx) => {
  const lastComma = line.lastIndexOf(",");
  if (lastComma === -1) return;

  const udsagn = line.substring(0, lastComma).trim().replace(/^"|"$/g, '');
  const disc = line.substring(lastComma + 1).trim();

  if (!udsagn || !disc || !"DISC".includes(disc)) return;

  const questionIndex = Math.floor(idx / 4);
  if (!questions[questionIndex]) {
    questions[questionIndex] = {
      text: `Sp√∏rgsm√•l ${questionIndex + 1}: Hvilket udsagn passer bedst (MEST) og d√•rligst (MINDST) p√• dig?`,
      options: []
    };
  }

  questions[questionIndex].options.push({ text: udsagn, disc });
});

    // Fjern eventuelle tomme pladser (hvis CSV ikke er perfekt delt i 4)
    questions = questions.filter(Boolean);

    // Bland r√¶kkef√∏lgen af sp√∏rgsm√•l (Fisher‚ÄìYates)
    for (let i = questions.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [questions[i], questions[j]] = [questions[j], questions[i]];
    }

    // Bland r√¶kkef√∏lgen af udsagn inden i hvert sp√∏rgsm√•l
    questions.forEach(q => {
      for (let i = q.options.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [q.options[i], q.options[j]] = [q.options[j], q.options[i]];
      }
    });

    // Opdater sp√∏rgsm√•lstitler s√• de matcher den nye r√¶kkef√∏lge
    questions.forEach((q, i) => {
      q.text = `Sp√∏rgsm√•l ${i + 1}: Hvilket udsagn passer bedst (MEST) og d√•rligst (MINDST) p√• dig?`;
    });

    console.log("DISC-kort indl√¶st:", questions.length, "sp√∏rgsm√•l");
  })
  .catch(err => {
    console.error("Kunne ikke hente CSV:", err);
    alert("Der opstod en fejl ved indl√¶sning af sp√∏rgerammen.");
  });

}

// Likert: hent udsagn fra disc_udsagn_2.0.csv
function fetchLikertItems() {
  const path = "disc_udsagn_2.0.csv";
  return fetch(path)
    .then(response => response.text())
    .then(data => {
      const lines = data.trim().split('\n').slice(1); // skip header
      likertItems = [];
      lines.forEach(line => {
        const lastComma = line.lastIndexOf(",");
        if (lastComma === -1) return;
        const udsagn = line.substring(0, lastComma).trim().replace(/^"|"$/g, '');
        const disc = line.substring(lastComma + 1).trim();
        if (!udsagn) return;
        likertItems.push({ text: udsagn, disc });
      });
      // Bland r√¶kkef√∏lgen for at undg√• ordensbias
      for (let i = likertItems.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [likertItems[i], likertItems[j]] = [likertItems[j], likertItems[i]];
      }
      // Grupp√©r i blokke √° 4 udsagn
      likertQuestions = [];
      for (let i = 0; i < likertItems.length; i += 4) {
        const group = likertItems.slice(i, i + 4);
        if (group.length === 4) {
          likertQuestions.push({ items: group });
        }
      }
      // Forbered svarstruktur: to v√¶rdier pr. udsagn (naturlig/arbejde)
      likertAnswers = likertQuestions.map(q =>
        q.items.map(item => ({
          text: item.text,
          disc: item.disc || "",
          naturlig: null,
          arbejde: null
        }))
      );
      likertCurrent = 0;
      console.log("Likert-udsagn indl√¶st:", likertItems.length, "‚Äì grupper:", likertQuestions.length);
    })
    .catch(err => {
      console.error("Kunne ikke hente Likert-CSV:", err);
      alert("Der opstod en fejl ved indl√¶sning af Likert-sp√∏rgerammen.");
    });
}

// Likert: vis √©t sp√∏rgsm√•l ad gangen med 4 udsagn og to Likert-kolonner (sliders 1‚Äì5)
function renderLikertSurvey() {
  const container = document.getElementById("questions");
  container.innerHTML = "";

  const q = likertQuestions[likertCurrent];
  const wrapper = document.createElement("div");
  wrapper.classList.add("question");

  const header = document.createElement("h2");
  header.style.marginTop = "0";
  header.textContent = `Sp√∏rgsm√•l ${likertCurrent + 1}: I hvilken grad passer nedenst√•ende udsagn p√• dig?`;
  wrapper.appendChild(header);

  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th>Udsagn</th>
        <th>Min naturlige adf√¶rd</th>
        <th>Adf√¶rd p√• mit arbejde</th>
      </tr>
    </thead>
    <tbody id="likert-body"></tbody>
  `;
  wrapper.appendChild(table);

  const tbody = table.querySelector("#likert-body");
  const labels = ["Meget uenig", "Uenig", "B√•de/og", "Enig", "Meget enig"];

  q.items.forEach((item, row) => {
    const answer = likertAnswers[likertCurrent][row];
    const tr = document.createElement("tr");

    const makeCell = (type) => {
      const td = document.createElement("td");
      td.style.textAlign = "left";
      td.style.verticalAlign = "middle";

      // Header labels over slider (klikbare)
      const labelBar = document.createElement("div");
      labelBar.className = "likert-labels";
      labelBar.style.display = "grid";
      labelBar.style.gridTemplateColumns = "repeat(5, 1fr)";
      labelBar.style.gap = "6px";
      labelBar.style.fontSize = "12px";
      labelBar.style.marginBottom = "6px";

      const labelSpans = [];
      for (let v = 1; v <= 5; v++) {
        const sp = document.createElement("span");
        sp.textContent = labels[v - 1];
        sp.dataset.val = String(v);
        labelBar.appendChild(sp);
        labelSpans.push(sp);
      }
      td.appendChild(labelBar);

      // Brug kun klikbare labels (ingen slider)
      const currentVal = (type === "naturlig" ? answer.naturlig : answer.arbejde);

      // Funktion til at opdatere label-highlights
      const updateLabels = (val) => {
        labelSpans.forEach(sp => {
          if (parseInt(sp.dataset.val, 10) === val) {
            sp.classList.add("selected");
          } else {
            sp.classList.remove("selected");
          }
        });
      };
      if (currentVal != null) updateLabels(currentVal);

      // Klik p√• label s√¶tter v√¶rdi direkte
      labelSpans.forEach(sp => {
        sp.addEventListener("click", () => {
          const v = parseInt(sp.dataset.val, 10);
          updateLabels(v);
          const qIdx = likertCurrent;
          const rIdx = row;
          const kind = type;
          likertAnswers[qIdx][rIdx][kind] = v;
        });
      });

      return td;
    };

    const tdText = document.createElement("td");
    tdText.textContent = item.text;
    tdText.style.fontSize = "18px";
    tdText.style.fontWeight = "600";

    tr.appendChild(tdText);
    tr.appendChild(makeCell("naturlig"));
    tr.appendChild(makeCell("arbejde"));
    tbody.appendChild(tr);
  });

  const nextBtn = document.createElement("button");
  nextBtn.className = "submit-button";
  nextBtn.textContent = (likertCurrent === likertQuestions.length - 1) ? "Afslut og indsend" : "N√¶ste";
  nextBtn.onclick = () => {
    // valider at alle 4 r√¶kker har begge valg
    const rows = likertAnswers[likertCurrent];
    const incomplete = rows.findIndex(r => r.naturlig == null || r.arbejde == null);
    if (incomplete !== -1) {
      alert("Udfyld venligst alle vurderinger (begge kolonner) f√∏r du forts√¶tter.");
      return;
    }
    if (likertCurrent < likertQuestions.length - 1) {
      likertCurrent += 1;
      renderLikertSurvey();
    } else {
      downloadLikertJSON();
    }
  };

  wrapper.appendChild(nextBtn);
  container.appendChild(wrapper);
}

// Likert: indsamling og download af JSON (to svar pr. udsagn)
async function downloadLikertJSON() {
  // Valider alle sp√∏rgsm√•l
  for (let q = 0; q < likertAnswers.length; q++) {
    const rows = likertAnswers[q];
    const incomplete = rows.findIndex(r => r.naturlig == null || r.arbejde == null);
    if (incomplete !== -1) {
      alert(`Sp√∏rgsm√•l ${q + 1} mangler besvarelser. Udfyld venligst alle vurderinger.`);
      likertCurrent = q;
      renderLikertSurvey();
      return;
    }
  }

  if (!confirm("Er du sikker p√•, at du vil indsende din besvarelse?")) return;

  // Saml svar
  const likertResponses = likertAnswers.flatMap((rows, qIndex) =>
    rows.map((row, rIndex) => ({
      question: qIndex + 1,
      index: rIndex + 1,
      text: row.text,
      disc: row.disc || "",
      naturlig: row.naturlig,
      arbejde: row.arbejde
    }))
  );

  // Bevar score-struktur for kompatibilitet (0-v√¶rdier som placeholder)
  const score = { D1: 0, I1: 0, S1: 0, C1: 0, D2: 0, I2: 0, S2: 0, C2: 0 };

  const result = {
    ...respondentInfo,
    score,
    likert: {
      scale: [
        { value: 1, label: "Meget uenig" },
        { value: 2, label: "Uenig" },
        { value: 3, label: "B√•de/og" },
        { value: 4, label: "Enig" },
        { value: 5, label: "Meget enig" }
      ],
      responses: likertResponses
    }
  };

  const jsonBlob = new Blob([JSON.stringify(result, null, 2)], { type: "application/json" });

  if (window.showSaveFilePicker) {
    const handle = await window.showSaveFilePicker({
      suggestedName: "disc-resultat-likert.json",
      types: [{
        description: "JSON-fil",
        accept: { "application/json": [".json"] }
      }]
    });
    const writable = await handle.createWritable();
    await writable.write(jsonBlob);
    await writable.close();
  } else {
    const url = URL.createObjectURL(jsonBlob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "disc-resultat-likert.json";
    link.click();
    URL.revokeObjectURL(url);
  }

  document.getElementById("questions").style.display = "none";
  document.getElementById("thankYouScreen").style.display = "block";
}



function startSurvey() {
	const rawDate = document.getElementById("inputDato").value;
	const parts = rawDate.split("-");
	const dato = parts.length === 3 ? `${parts[2]}${parts[1]}${parts[0]}` : "";

  const fornavn = document.getElementById("inputFornavn").value;
  const efternavn = document.getElementById("inputEfternavn").value;
  const profiltype = document.getElementById("inputProfiltype").value;
  const spoergeramme = document.getElementById("inputSpoergeramme").value;
  const koen = document.getElementById("inputKoen").value;
  const firma = document.getElementById("inputFirma").value;
  const email = document.getElementById("inputEmail").value;
  const samtykke = document.getElementById("inputSamtykke").checked;

  if (!dato || !fornavn || !efternavn || !email || !koen || !profiltype || !spoergeramme || !samtykke) {
    alert("Du skal udfylde alle felter og give samtykke for at forts√¶tte.");
    return;
  }

  respondentInfo = {
    dato,
    fornavn,
    efternavn,
    profiltype,
    spoergeramme,
    koen,
    firma,
    email
  };

  // Skjul intro, vis sp√∏rgsm√•l
document.getElementById("introForm").style.display = "none";
document.getElementById("prepScreen").style.display = "block";
}

function showSurvey() {
  document.getElementById("prepScreen").style.display = "none";
  document.getElementById("questions").style.display = "block";

  if (respondentInfo.spoergeramme === "Likert") {
    fetchLikertItems().then(() => {
      renderLikertSurvey();
    });
  } else {
    fetchQuestions(respondentInfo.spoergeramme).then(() => {
      renderQuestions();
      setupValidation();
    });
  }
}


function setupValidation() {
  questions.forEach((q, i) => {
    const mestInputs = document.querySelectorAll(`input[name='mest${i}']`);
    const mindstInputs = document.querySelectorAll(`input[name='mindst${i}']`);

    mestInputs.forEach(input => {
      input.addEventListener('change', () => {
        mindstInputs.forEach(min => {
          if (min.value === input.value && input.checked) {
            min.checked = false; // fjern MINDST hvis MEST er valgt samme sted
          }
        });
      });
    });

    mindstInputs.forEach(input => {
      input.addEventListener('change', () => {
        mestInputs.forEach(mest => {
          if (mest.value === input.value && input.checked) {
            mest.checked = false; // fjern MEST hvis MINDST er valgt samme sted
          }
        });
      });
    });
  });
}

function renderQuestions() {
  const container = document.getElementById("questions");
  container.innerHTML = "";
  showQuestion(0);
}

function showQuestion(index) {
  const q = questions[index];
  const container = document.getElementById("questions");
  container.innerHTML = "";

  const div = document.createElement("div");
  div.classList.add("question");
  div.setAttribute("id", `question-${index}`);
  div.innerHTML = `<p><strong>${q.text}</strong></p>`;

  const table = document.createElement("table");
  table.innerHTML = `
    <tr>
      <th>Udsagn</th>
      <th>MEST</th>
      <th>MINDST</th>
    </tr>
  `;

  q.options.forEach((opt, j) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${opt.text}</td>
      <td><input type="radio" name="mest${index}" value="${opt.text}" data-disc="${opt.disc}" id="mest-${index}-${j}"></td>
      <td><input type="radio" name="mindst${index}" value="${opt.text}" data-disc="${opt.disc}" id="mindst-${index}-${j}"></td>
    `;
    table.appendChild(row);
  });

  div.appendChild(table);

  // Automatisk gensidig udelukkelse
  setTimeout(() => {
    const mestRadios = document.querySelectorAll(`input[name='mest${index}']`);
    const mindstRadios = document.querySelectorAll(`input[name='mindst${index}']`);

    mestRadios.forEach((mest) => {
      mest.addEventListener("change", () => {
        mindstRadios.forEach((mindst) => {
          if (mindst.value === mest.value && mest.checked) {
            mindst.checked = false;
          }
        });
      });
    });

    mindstRadios.forEach((mindst) => {
      mindst.addEventListener("change", () => {
        mestRadios.forEach((mest) => {
          if (mest.value === mindst.value && mindst.checked) {
            mest.checked = false;
          }
        });
      });
    });
  }, 50);

  const nextBtn = document.createElement("button");
  nextBtn.textContent = index === questions.length - 1 ? "Afslut og indsend" : "N√¶ste";
  nextBtn.className = "submit-button";

  nextBtn.onclick = () => {
  const mest = document.querySelector(`input[name='mest${index}']:checked`);
  const mindst = document.querySelector(`input[name='mindst${index}']:checked`);

  if (!mest || !mindst) {
    alert("Du skal v√¶lge b√•de MEST og MINDST f√∏r du kan forts√¶tte.");
    return;
  }

  const mestDISC = mest.dataset.disc;
  const mindstDISC = mindst.dataset.disc;

  answers[index] = { mest: mestDISC, mindst: mindstDISC }; // üíæ gem svar

  if (index + 1 < questions.length) {
    showQuestion(index + 1);
  } else {
    downloadJSON(); // kald direkte
  }
};

  div.appendChild(nextBtn);
  container.appendChild(div);
}

function createQuestionElement(index) {
  const q = questions[index];
  const div = document.createElement("div");
  div.classList.add("question");
  div.setAttribute("id", `question-${index}`);
  div.innerHTML = `<p><strong>${q.text}</strong></p>`;

  const table = document.createElement("table");
  table.innerHTML = `
    <tr>
      <th>Udsagn</th>
      <th>MEST</th>
      <th>MINDST</th>
    </tr>
  `;

  q.options.forEach((opt, j) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${opt.text}</td>
      <td><input type="radio" name="mest${index}" value="${opt.text}" data-disc="${opt.disc}"></td>
      <td><input type="radio" name="mindst${index}" value="${opt.text}" data-disc="${opt.disc}"></td>
    `;
    table.appendChild(row);
  });

  div.appendChild(table);

  // overv√•g MEST og MINDST valg
  div.addEventListener("change", () => {
    const mest = document.querySelector(`input[name='mest${index}']:checked`);
    const mindst = document.querySelector(`input[name='mindst${index}']:checked`);
    if (mest && mindst) {
      if (index + 1 < questions.length) {
        const next = document.getElementById(`question-${index + 1}`);
        if (!next) {
          const nextQuestion = createQuestionElement(index + 1);
          document.getElementById("questions").appendChild(nextQuestion);
          nextQuestion.scrollIntoView({ behavior: "smooth" });
        }
      } else {
        document.getElementById("submitBtn").style.display = "block";
        document.getElementById("submitBtn").scrollIntoView({ behavior: "smooth" });
      }
    }
  });

  return div;
}


async function downloadJSON() {
  if (!confirm("Er du sikker p√•, at du vil indsende din besvarelse?")) return;

  const score = { D1: 0, I1: 0, S1: 0, C1: 0, D2: 0, I2: 0, S2: 0, C2: 0 };

  answers.forEach(ans => {
  if (ans?.mest && score[ans.mest + '1'] !== undefined) {
    score[ans.mest + '1']++;
  }
  if (ans?.mindst && score[ans.mindst + '2'] !== undefined) {
    score[ans.mindst + '2']++;
  }
});



  const result = {
    ...respondentInfo,
    score
  };

  const jsonBlob = new Blob([JSON.stringify(result, null, 2)], { type: "application/json" });

  // Brug moderne file picker hvis muligt
  if (window.showSaveFilePicker) {
    const handle = await window.showSaveFilePicker({
      suggestedName: "disc-resultat.json",
      types: [{
        description: "JSON-fil",
        accept: { "application/json": [".json"] }
      }]
    });
    const writable = await handle.createWritable();
    await writable.write(jsonBlob);
    await writable.close();
  } else {
    // fallback til klassisk download
    const url = URL.createObjectURL(jsonBlob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "disc-resultat.json";
    link.click();
    URL.revokeObjectURL(url);
  }

  document.getElementById("questions").style.display = "none";
  document.getElementById("thankYouScreen").style.display = "block";

}

async function uploadToGitHub() {
  if (!confirm("Er du sikker p√•, at du vil indsende din besvarelse?")) return;

  const score = { D1: 0, I1: 0, S1: 0, C1: 0, D2: 0, I2: 0, S2: 0, C2: 0 };

  answers.forEach(ans => {
    if (ans?.mest && score[ans.mest + '1'] !== undefined) {
      score[ans.mest + '1']++;
    }
    if (ans?.mindst && score[ans.mindst + '2'] !== undefined) {
      score[ans.mindst + '2']++;
    }
  });

  const result = {
    ...respondentInfo,
    score
  };

  // üîê GitHub config
  const GITHUB_USERNAME = "lukasbjohansen";
  const GITHUB_REPO = "DISC";
  const GITHUB_TOKEN = "ghp_xxxDIN_PERSONLIGE_TOKENxxx"; // üëà Inds√¶t sikkert!
  const FILE_PATH = `input/disc-${Date.now()}.json`;

  const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${FILE_PATH}`;

  const encodedContent = btoa(
  new TextEncoder().encode(JSON.stringify(result, null, 2))
    .reduce((data, byte) => data + String.fromCharCode(byte), '')
);

  const body = {
    message: `New DISC submission by ${respondentInfo.fornavn} ${respondentInfo.efternavn}`,
    content: encodedContent,
    committer: {
      name: "DISC Bot",
      email: "bot@coachers.dk"
    }
  };

  const response = await fetch(apiUrl, {
    method: "PUT",
    headers: {
      "Authorization": `Bearer ${GITHUB_TOKEN}`,
      "Accept": "application/vnd.github.v3+json",
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });

  if (response.ok) {
    alert("Svar indsendt og gemt p√• GitHub!");
    location.reload();
  } else {
    const error = await response.json();
    console.error("GitHub upload-fejl:", error);
    alert("Der opstod en fejl under indsendelsen.");
  }
}


window.addEventListener("DOMContentLoaded", () => {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0'); // m√•neder = 0-indekseret
  const dd = String(today.getDate()).padStart(2, '0');

  const todayString = `${yyyy}-${mm}-${dd}`; // HTML date format
  document.getElementById("inputDato").value = todayString;
});



</script>

</body>
</html>
